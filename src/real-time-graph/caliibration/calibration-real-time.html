<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>real time graph</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.js"></script>
    <style>
        h4{ color:#096073 }
        #text{
        position: absolute;
        top: 50%;
        left: 250px;
        font-size: 10px;
        color: #096073;
        transform: translate(-50%,-50%);
        -ms-transform: translate(-50%,-50%);
        padding: 10px;
        border-style:solid;
        border-width:5px;
        border-color:#096073;
        border-radius:5px;
        opacity: 0;
        }
        </style>
</head>

<body>
    <h1>Caffeine</h1>
    <div margin="auto" max-width="1050px" padding="20" text-align="center">
        <div id="text"></div>
    <canvas id="chart" width="1000" height="500" margin="auto" display="block"></canvas>
</div>
    <script>
        var hoverMode = false;
        var first = "https://raw.githubusercontent.com/jw4590/Virtual-Chem-Lab/data/data/DopingLab_dev/Calibrations/Caffeine1.csv";
        var second = "https://raw.githubusercontent.com/jw4590/Virtual-Chem-Lab/data/data/DopingLab_dev/Calibrations/Caffeine2.csv";
        var third = "https://raw.githubusercontent.com/jw4590/Virtual-Chem-Lab/data/data/DopingLab_dev/Calibrations/Caffeine3.csv";
        var forth = "https://raw.githubusercontent.com/jw4590/Virtual-Chem-Lab/data/data/DopingLab_dev/Calibrations/Caffeine4.csv";
        const x1 = [];
        const y1 = [];
        const x2 = [];
        const y2 = [];
        const x3 = [];
        const y3 = [];
        const x4 = [];
        const y4 = [];

        const ctx = document.getElementById('chart').getContext('2d');
        var myChart = new Chart(ctx, {
            type: 'line',
            data: {
                // change this to make it draw a data set instead of just y value
                labels: [],
                datasets: [{
                    label: 'caffeine 1',
                    data: [],
                    backgroundColor: 
                  'rgba(163, 216, 108, 1)',
                },
                {
                    label: 'caffeine 2',
                    data: [],
                    backgroundColor: 
                  'rgba(86, 191, 132, 1)',
                },
                {
                    label: 'caffeine 3',
                    data: [],
                    backgroundColor: 
                  'rgba(8, 166, 150, 1)',
                },
                {
                    label: 'caffeine 4',
                    data: [],
                    backgroundColor: 
                  'rgba(9, 96, 115, 1)',
                },
                ]},
            options: {
                responsive: false,
                scales: {
                    xAxes: [{
                        ticks: {
                        max: 10,
                        min: 0,
                        maxTicksLimit: 21,
                        beginAtZero:true
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Retention Time (min)'
                        }
                    }],
                    yAxes: [{
                        ticks: {
                        max: 8000,
                        min: 0,
                        maxTicksLimit: 5,
                        beginAtZero:true
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Signal (arb. units)'
                        }
                    }],
                },
                    //onClick:function (elements) {
                    //    console.log(elements);}
                    //onClick: getCursorPosition,
                hover: {
                    // Overrides the global setting
                    enabled: true,
                    //mode: 'dataset',
                    onHover: function(elements) {
                        getCursorPosition(elements);
                    }
                }   
            }
        });

        async function getData(fileSource,x,y){
            const response = await fetch(fileSource);
            const data = await response.text();
            console.log(data);

            const rows = data.split('\n');
            console.log(rows);
            rows.forEach(elt => {
                const row = elt.split(',');
                const time = parseFloat(row[0]);
                x.push(time);
                const signal = parseFloat(row[1]);
                y.push(signal);
                console.log(time,signal);
            });
        }

        async function chartIt(){
            hoverMode = false;
            await getData(first,x1,y1);
            await getData(second,x2,y2);
            await getData(third,x3,y3);
            await getData(forth,x4,y4);
            var i;
            for(i=0; i < x1.length; i++){
                //await sleep(x1[i]*0.1);
                addData(myChart,x1[i],y1[i],y2[i],y3[i],y4[i]);
            }
            hoverMode = true;  
        }

        function addData(chart, label, data1,data2,data3,data4) {
            chart.data.labels.push(label);
            //chart.data.datasets.forEach((dataset) => {
            //    dataset.data.push(data);
            //});
            chart.data.datasets[0].data.push(data1);
            chart.data.datasets[1].data.push(data2);
            chart.data.datasets[2].data.push(data3);
            chart.data.datasets[3].data.push(data4);
            chart.update();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function getCursorPosition(event) {
            var i;
            if(hoverMode){
            const can = document.getElementById('chart');
            const rect = can.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            console.log(y);
            var chartX=(x-54)/99.4;
            //var chartY=(430-y)*(20.1);
            //console.log(chartX,chartY);
                for(i=191;i<301;i++){
                    //if(Math.abs(chartX-x1[i])<0.05){
                        if(418<y<430){
                            console.log("entered1.")
                            document.getElementById("text").innerHTML="Area for Peak1<br>Width of Peak1";
                            document.getElementById("text").style.opacity="1";
                            //return;     
                        }
                        if(395<y<418){
                            console.log("entered2.")
                            document.getElementById("text").innerHTML="Area for Peak2<br>Width of Peak2";
                            document.getElementById("text").style.opacity="1";
                            //return; 
                        }
                        if(300<y<395){
                            console.log("entered3.")
                            document.getElementById("text").innerHTML="Area for Peak3<br>Width of Peak3";
                            document.getElementById("text").style.opacity="1";
                            //return; 
                        }
                        if(100<y<300){
                            console.log("entered4.")
                            document.getElementById("text").innerHTML="Area for Peak4<br>Width of Peak4";
                            document.getElementById("text").style.opacity="1";
                            //return;
                        }
                    //}
                }
                document.getElementById("text").innerHTML="";
                document.getElementById("text").style.opacity="0";
               
            }
        }


        chartIt();

    </script>

</body>
</html>